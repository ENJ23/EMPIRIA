<div class="event-detail-container" *ngIf="event$ | async as event; else loading">
    <div class="hero-banner" [style.backgroundImage]="'url(' + event.imageUrl + ')'">
        <div class="overlay"></div>
        <div class="container hero-content">
            <div class="badges-row">
                <span class="category-badge">{{ event.categories[0] }}</span>
                <span class="presale-badge-hero" *ngIf="event.isPreventa">
                    <span class="material-icons">local_offer</span> PREVENTA EXCLUSIVA
                </span>
            </div>
            <h1 class="event-title">{{ event.title }}</h1>
            <div class="event-meta">
                <span class="meta-item">
                    <span class="material-icons">calendar_today</span>
                    {{ event.date | date:'fullDate' }}
                </span>
                <span class="meta-item">
                    <span class="material-icons">location_on</span>
                    {{ event.location }}
                </span>
            </div>
        </div>
    </div>

    <div class="container content-grid">
        <div class="main-content">
            <section class="section">
                <h2 class="section-heading">Sobre el Evento</h2>
                <p class="description">{{ event.description }}</p>
            </section>

            <section class="section">
                <h2 class="section-heading">Organizador</h2>
                <div class="organizer-card">
                    <div class="organizer-avatar">E</div>
                    <div>
                        <h4>Empiria Jujuy</h4>
                        <p>Organizadora Oficial</p>
                    </div>
                </div>
            </section>
        </div>

        <aside class="sidebar">
            <div class="ticket-card">
                <h3>Adquirir Entradas</h3>

                <!-- Availability Status -->
                <div class="availability-status" [class.sold-out]="isSoldOut">
                    <span class="material-icons">{{ isSoldOut ? 'block' : 'inventory_2' }}</span>
                    <div class="availability-text">
                        <span *ngIf="!isSoldOut" class="available-count">
                            {{ availableTickets }} {{ availableTickets === 1 ? 'entrada disponible' : 'entradas
                            disponibles' }}
                        </span>
                        <span *ngIf="isSoldOut" class="sold-out-text">
                            ⚠️ ENTRADAS AGOTADAS
                        </span>
                    </div>
                </div>

                <div class="ticket-type" [class.selected]="selectedTicket === 'general'" [class.disabled]="isSoldOut"
                    (click)="selectTicket('general', (event.isPreventa && event.preventaPrice) ? event.preventaPrice : event.priceRange.min)">
                    <div class="ticket-info">
                        <div class="ticket-name-row">
                            <span class="ticket-name">General</span>
                            <span class="badge-preventa-small" *ngIf="event.isPreventa">
                                OFERTA
                            </span>
                        </div>
                        <span class="ticket-stock">Disponibles</span>
                    </div>
                    <div class="price-column">
                        <span class="old-price"
                            *ngIf="event.isPreventa && event.preventaPrice && event.preventaPrice < event.priceRange.min">
                            ${{ event.priceRange.min }}
                        </span>
                        <span class="ticket-price" [class.highlight-price]="event.isPreventa">
                            ${{ (event.isPreventa && event.preventaPrice) ? event.preventaPrice : event.priceRange.min
                            }}
                        </span>
                    </div>
                </div>

                <div class="ticket-type" [class.selected]="selectedTicket === 'vip'" [class.disabled]="isSoldOut"
                    (click)="selectTicket('vip', event.priceRange.max)">
                    <div class="ticket-info">
                        <span class="ticket-name">VIP Experience</span>
                        <span class="ticket-stock">Últimos lugares</span>
                    </div>
                    <span class="ticket-price">${{ event.priceRange.max }}</span>
                </div>

                <div class="summary" *ngIf="selectedTicket">
                    <div class="summary-row">
                        <span>Entrada {{ selectedTicket | titlecase }}</span>
                        <span>${{ currentPrice }}</span>
                    </div>
                    <div class="summary-row">
                        <span>Cantidad</span>
                        <div class="quantity-selector">
                            <button class="qty-btn" (click)="decrementQuantity()" [disabled]="selectedQuantity <= 1">
                                <span class="material-icons">remove</span>
                            </button>
                            <input type="number" min="1" [max]="availableTickets" [disabled]="isSoldOut"
                                [value]="selectedQuantity" (input)="setQuantity($any($event.target).valueAsNumber)"
                                class="qty-input" />
                            <button class="qty-btn" (click)="incrementQuantity()"
                                [disabled]="selectedQuantity >= availableTickets || isSoldOut">
                                <span class="material-icons">add</span>
                            </button>
                        </div>
                        <div class="qty-hint" *ngIf="!isSoldOut && availableTickets > 0 && selectedQuantity >= availableTickets">
                            Máximo permitido: {{ availableTickets }} {{ availableTickets === 1 ? 'entrada' : 'entradas' }}.
                        </div>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span>${{ currentPrice * selectedQuantity }}</span>
                    </div>
                </div>

                <!-- Inline error alert for capacity/availability issues -->
                <div class="alert error" *ngIf="purchaseErrorMsg">
                    <span class="material-icons">error</span>
                    <div class="alert-content">
                        <strong>{{ purchaseErrorMsg }}</strong>
                        <div class="alert-sub"
                            *ngIf="purchaseErrorDetails.available !== undefined && !purchaseErrorDetails.soldOut">
                            Quedan {{ purchaseErrorDetails.available }}
                            {{ purchaseErrorDetails.available === 1 ? 'entrada' : 'entradas' }} disponibles.
                        </div>
                        <div class="alert-sub" *ngIf="purchaseErrorDetails.soldOut">
                            No hay más entradas disponibles para este evento.
                        </div>
                    </div>
                </div>

                <button class="btn btn-block" [disabled]="!selectedTicket || isProcessing || isSoldOut"
                    (click)="purchase()">
                    {{ isSoldOut ? 'Entradas Agotadas' : isProcessing ? 'Procesando...' : 'Confirmar Compra' }}
                </button>
                <p class="secure-note">
                    <span class="material-icons">lock</span> Pago 100% Seguro
                </p>
            </div>
        </aside>
    </div>
</div>

<ng-template #loading>
    <div class="container section text-center">
        <p>Cargando evento...</p>
    </div>
</ng-template>

<!-- Payment Modal -->
<div class="modal-overlay" *ngIf="showPaymentModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <h3>Finalizar Compra</h3>
        <p>Escanea el código QR con tu celular o haz clic en el botón para pagar.</p>

        <div class="qr-container" *ngIf="qrCodeUrl">
            <img [src]="qrCodeUrl" alt="QR de Pago">
        </div>

        <div class="modal-actions">
            <a [href]="paymentUrl" class="btn" target="_blank">
                Pagar con Mercado Pago
            </a>
            <button class="btn-secondary" (click)="closeModal()">
                Cancelar
            </button>
        </div>
    </div>
</div>